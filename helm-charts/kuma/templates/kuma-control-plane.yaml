apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: {{ .Values.mesh.name }}
spec:
  mtls:
    enabled: {{ .Values.mesh.mtls.enabled }}

---
apiVersion: kuma.io/v1alpha1
kind: MeshGateway
metadata:
  name: {{ .Values.gateway.name }}
  namespace: {{ .Values.gateway.namespace }}
spec:
  tags:
    service: {{ .Values.gateway.tags.service }}
  conf:
    listeners:
      - port: {{ .Values.gateway.network.port }}
        protocol: http

---
apiVersion: kuma.io/v1alpha1
kind: Dataplane
metadata:
  name: {{ .Values.dataplane.name }}
  namespace: {{ .Values.dataplane.namespace }}
spec:
  network:
    inbound:
{{- range .Values.dataplane.network.inbound }}
      - port: {{ .port }}
        servicePort: {{ .servicePort }}
        tags:
{{ toYaml .tags | indent 10 }}
{{- end }}
    outbound:
{{- range .Values.dataplane.network.outbound }}
      - service: {{ .service }}
{{- end }}
  mesh: {{ .Values.dataplane.mesh }}
  tags:
{{ toYaml .Values.dataplane.tags | indent 4 }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kuma-control-plane
  namespace: kuma-system
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: kuma
  template:
    metadata:
      labels:
        app: kuma
    spec:
      containers:
        - name: kuma-cp
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: {{ .Values.controlPlane.command | toJson }}
          args: {{ .Values.controlPlane.args | toJson }}
          ports:
            - name: admin
              containerPort: 5681
              protocol: TCP
            - name: grpc
              containerPort: 5682
              protocol: TCP
          resources:
            requests:
              memory: {{ .Values.resources.requests.memory }}
              cpu: {{ .Values.resources.requests.cpu }}
            limits:
              memory: {{ .Values.resources.limits.memory }}
              cpu: {{ .Values.resources.limits.cpu }}